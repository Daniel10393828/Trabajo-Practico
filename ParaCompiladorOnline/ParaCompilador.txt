
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define MAX_ESTUDIANTES 100
#define MAX_MATERIAS 50

// ============ ESTRUCTURAS ============

// Definición de la estructura de estudiante
typedef struct {
    int id;
    char nombre[100];
    int edad;
    char materiaInscrita[100][50];
    int cantidadMaterias;
    float promedio;
} Estudiante;

// Definición de la estructura de Materia
typedef struct {
    char nombre[100];
    int codigo;
    int correlativas[10];
    int cantidadCorrelativas;
    int aprobada;
} Materia;

// ============ DECLARACIÓN DE FUNCIONES ============

// Funciones de estudiantes
void agregarEstudiante(Estudiante estudiantes[], int *totalEstudiantes);
void listarEstudiantes(Estudiante estudiantes[], int totalEstudiantes);
void modificarEstudiante(Estudiante estudiantes[], int totalEstudiantes);
void eliminarEstudiante(Estudiante estudiantes[], int *totalEstudiantes, int id);
Estudiante* buscarEstudiantePorNombre(Estudiante estudiantes[], int totalEstudiantes, const char* nombre);
Estudiante* buscarEstudiantePorId(Estudiante estudiantes[], int totalEstudiantes, int id);
Estudiante* buscarEstudiantePorEdad(Estudiante estudiantes[], int totalEstudiantes, int minEdad, int maxEdad);
void inscribirMateria(Estudiante estudiantes[], int totalEstudiantes, const char* materia);
void calcularPromedio(Estudiante *estudiante);

// Funciones de materias
void agregarMateria(Materia materias[], int *totalMaterias);
void listarMaterias(Materia materias[], int totalMaterias);
void modificarMateria(Materia materias[], int totalMaterias);
void eliminarMateria(Materia materias[], int *totalMaterias, int codigo);
Materia *buscarMateriaPorCodigo(Materia materias[], int totalMaterias, int codigo);
Materia *buscarMateriaPorNombre(Materia materias[], int totalMaterias, const char *nombre);
void inscribirEstudianteEnMateria(Estudiante estudiantes[], int totalEstudiantes, Materia materias[], int totalMaterias, int estudianteId, int materiaCodigo);

// Funciones auxiliares
void mostrarMenu();
void ordenarEstudiantesPorNombre(Estudiante estudiantes[], int totalEstudiantes);
void ordenarMateriasPorNombre(Materia materias[], int totalMaterias);
void cargarEstudiantesDesdeCSV(Estudiante estudiantes[], int *totalEstudiantes, const char *archivo);
void guardarEstudiantesEnCSV(Estudiante estudiantes[], int totalEstudiantes, const char *archivo);
void cargarMateriasDesdeCSV(Materia materias[], int *totalMaterias, const char *archivo);
void guardarMateriasEnCSV(Materia materias[], int totalMaterias, const char *archivo);
int esIdUnico(Estudiante estudiantes[], int totalEstudiantes, int id);
int verificarCorrelativas(Materia materias[], int totalMaterias, Estudiante *estudiante, const char *materia);

// ============ IMPLEMENTACIÓN DE FUNCIONES DE ESTUDIANTES ============

void agregarEstudiante(Estudiante estudiantes[], int *totalEstudiantes) {
    Estudiante nuevoEstudiante;

    printf("Ingrese el ID del estudiante: ");
    scanf("%d", &nuevoEstudiante.id);

    if (!esIdUnico(estudiantes, *totalEstudiantes, nuevoEstudiante.id)) {
        printf("El ID ya existe. Intente con otro ID.\n");
        return;
    }

    printf("Ingrese el nombre del estudiante: ");
    getchar();
    fgets(nuevoEstudiante.nombre, sizeof(nuevoEstudiante.nombre), stdin);
    nuevoEstudiante.nombre[strcspn(nuevoEstudiante.nombre, "\n")] = 0;

    printf("Ingrese la edad del estudiante: ");
    scanf("%d", &nuevoEstudiante.edad);

    nuevoEstudiante.cantidadMaterias = 0;
    nuevoEstudiante.promedio = 0.0;

    estudiantes[*totalEstudiantes] = nuevoEstudiante;
    (*totalEstudiantes)++;
    printf("Estudiante agregado con éxito.\n");
}

void listarEstudiantes(Estudiante estudiantes[], int totalEstudiantes) {
    if (totalEstudiantes == 0) {
        printf("No hay estudiantes registrados.\n");
        return;
    }

    printf("\nLista de Estudiantes:\n");
    for (int i = 0; i < totalEstudiantes; i++) {
        printf("ID: %d | Nombre: %s | Edad: %d | Promedio: %.2f\n", 
               estudiantes[i].id, estudiantes[i].nombre, 
               estudiantes[i].edad, estudiantes[i].promedio);
    }
}

void modificarEstudiante(Estudiante estudiantes[], int totalEstudiantes) {
    int id;
    printf("Ingrese el ID del estudiante a modificar: ");
    scanf("%d", &id);

    Estudiante *estudiante = buscarEstudiantePorId(estudiantes, totalEstudiantes, id);
    if (estudiante != NULL) {
        printf("Modificar nombre del estudiante (actual: %s): ", estudiante->nombre);
        getchar();
        fgets(estudiante->nombre, sizeof(estudiante->nombre), stdin);
        estudiante->nombre[strcspn(estudiante->nombre, "\n")] = 0;

        printf("Modificar edad del estudiante (actual: %d): ", estudiante->edad);
        scanf("%d", &estudiante->edad);
        printf("Estudiante modificado con éxito.\n");
    } else {
        printf("Estudiante no encontrado.\n");
    }
}

void eliminarEstudiante(Estudiante estudiantes[], int *totalEstudiantes, int id) {
    int found = 0;
    for (int i = 0; i < *totalEstudiantes; i++) {
        if (estudiantes[i].id == id) {
            found = 1;
            for (int j = i; j < *totalEstudiantes - 1; j++) {
                estudiantes[j] = estudiantes[j + 1];
            }
            (*totalEstudiantes)--;
            printf("Estudiante eliminado con éxito.\n");
            break;
        }
    }
    if (!found) {
        printf("Estudiante con ID %d no encontrado.\n", id);
    }
}

Estudiante* buscarEstudiantePorNombre(Estudiante estudiantes[], int totalEstudiantes, const char* nombre) {
    for (int i = 0; i < totalEstudiantes; i++) {
        if (strcmp(estudiantes[i].nombre, nombre) == 0) {
            return &estudiantes[i];
        }
    }
    return NULL;
}

Estudiante* buscarEstudiantePorId(Estudiante estudiantes[], int totalEstudiantes, int id) {
    for (int i = 0; i < totalEstudiantes; i++) {
        if (estudiantes[i].id == id) {
            return &estudiantes[i];
        }
    }
    return NULL;
}

Estudiante* buscarEstudiantePorEdad(Estudiante estudiantes[], int totalEstudiantes, int minEdad, int maxEdad) {
    for (int i = 0; i < totalEstudiantes; i++) {
        if (estudiantes[i].edad >= minEdad && estudiantes[i].edad <= maxEdad) {
            return &estudiantes[i];
        }
    }
    return NULL;
}

void inscribirMateria(Estudiante estudiantes[], int totalEstudiantes, const char* materia) {
    int id;
    printf("Ingrese el ID del estudiante a inscribir en la materia '%s': ", materia);
    scanf("%d", &id);

    Estudiante *estudiante = buscarEstudiantePorId(estudiantes, totalEstudiantes, id);
    if (estudiante != NULL) {
        if (estudiante->cantidadMaterias < 100) {
            strcpy(estudiante->materiaInscrita[estudiante->cantidadMaterias], materia);
            estudiante->cantidadMaterias++;
            printf("Estudiante inscrito en la materia '%s' con éxito.\n", materia);
        } else {
            printf("El estudiante ya está inscrito en el máximo de materias.\n");
        }
    } else {
        printf("Estudiante no encontrado.\n");
    }
}

void calcularPromedio(Estudiante *estudiante) {
    if (estudiante->cantidadMaterias == 0) {
        printf("El estudiante no tiene materias inscritas.\n");
        return;
    }
    estudiante->promedio = 0.0;
    printf("Promedio calculado: %.2f\n", estudiante->promedio);
}

// ============ IMPLEMENTACIÓN DE FUNCIONES DE MATERIAS ============

void agregarMateria(Materia materias[], int *totalMaterias) {
    Materia nuevaMateria;

    printf("Ingrese el nombre de la materia: ");
    getchar();
    fgets(nuevaMateria.nombre, sizeof(nuevaMateria.nombre), stdin);
    nuevaMateria.nombre[strcspn(nuevaMateria.nombre, "\n")] = 0;

    printf("Ingrese el código de la materia: ");
    scanf("%d", &nuevaMateria.codigo);

    printf("Ingrese la cantidad de correlativas: ");
    scanf("%d", &nuevaMateria.cantidadCorrelativas);

    for (int i = 0; i < nuevaMateria.cantidadCorrelativas; i++) {
        printf("Ingrese el código de la correlativa %d: ", i + 1);
        scanf("%d", &nuevaMateria.correlativas[i]);
    }

    nuevaMateria.aprobada = 0;

    materias[*totalMaterias] = nuevaMateria;
    (*totalMaterias)++;
    printf("Materia '%s' agregada con éxito.\n", nuevaMateria.nombre);
}

void listarMaterias(Materia materias[], int totalMaterias) {
    if (totalMaterias == 0) {
        printf("No hay materias registradas.\n");
        return;
    }

    printf("\nLista de Materias:\n");
    for (int i = 0; i < totalMaterias; i++) {
        printf("Código: %d | Nombre: %s | Correlativas: ", 
               materias[i].codigo, materias[i].nombre);
        for (int j = 0; j < materias[i].cantidadCorrelativas; j++) {
            printf("%d ", materias[i].correlativas[j]);
        }
        printf("\n");
    }
}

void modificarMateria(Materia materias[], int totalMaterias) {
    int codigo;
    printf("Ingrese el código de la materia a modificar: ");
    scanf("%d", &codigo);

    Materia *materia = buscarMateriaPorCodigo(materias, totalMaterias, codigo);
    if (materia != NULL) {
        printf("Modificar nombre de la materia (actual: %s): ", materia->nombre);
        getchar();
        fgets(materia->nombre, sizeof(materia->nombre), stdin);
        materia->nombre[strcspn(materia->nombre, "\n")] = 0;

        printf("Modificar cantidad de correlativas (actual: %d): ", materia->cantidadCorrelativas);
        scanf("%d", &materia->cantidadCorrelativas);

        for (int i = 0; i < materia->cantidadCorrelativas; i++) {
            printf("Ingrese el código de la correlativa %d: ", i + 1);
            scanf("%d", &materia->correlativas[i]);
        }

        printf("Materia modificada con éxito.\n");
    } else {
        printf("Materia con código %d no encontrada.\n", codigo);
    }
}

void eliminarMateria(Materia materias[], int *totalMaterias, int codigo) {
    int found = 0;
    for (int i = 0; i < *totalMaterias; i++) {
        if (materias[i].codigo == codigo) {
            found = 1;
            for (int j = i; j < *totalMaterias - 1; j++) {
                materias[j] = materias[j + 1];
            }
            (*totalMaterias)--;
            printf("Materia con código %d eliminada con éxito.\n", codigo);
            break;
        }
    }
    if (!found) {
        printf("Materia con código %d no encontrada.\n", codigo);
    }
}

Materia *buscarMateriaPorCodigo(Materia materias[], int totalMaterias, int codigo) {
    for (int i = 0; i < totalMaterias; i++) {
        if (materias[i].codigo == codigo) {
            return &materias[i];
        }
    }
    return NULL;
}

Materia *buscarMateriaPorNombre(Materia materias[], int totalMaterias, const char *nombre) {
    for (int i = 0; i < totalMaterias; i++) {
        if (strcmp(materias[i].nombre, nombre) == 0) {
            return &materias[i];
        }
    }
    return NULL;
}

void inscribirEstudianteEnMateria(Estudiante estudiantes[], int totalEstudiantes, Materia materias[], int totalMaterias, int estudianteId, int materiaCodigo) {
    Estudiante *estudiante = buscarEstudiantePorId(estudiantes, totalEstudiantes, estudianteId);
    Materia *materia = buscarMateriaPorCodigo(materias, totalMaterias, materiaCodigo);

    if (estudiante != NULL && materia != NULL) {
        if (verificarCorrelativas(materias, totalMaterias, estudiante, materia->nombre)) {
            if (estudiante->cantidadMaterias < 100) {
                strcpy(estudiante->materiaInscrita[estudiante->cantidadMaterias], materia->nombre);
                estudiante->cantidadMaterias++;
                printf("Estudiante inscripto con éxito en la materia '%s'.\n", materia->nombre);
            } else {
                printf("El estudiante ya ha alcanzado el límite de materias inscritas.\n");
            }
        } else {
            printf("El estudiante no cumple con las correlativas necesarias para inscribirse en '%s'.\n", materia->nombre);
        }
    } else {
        printf("Estudiante o materia no encontrado.\n");
    }
}

// ============ IMPLEMENTACIÓN DE FUNCIONES AUXILIARES ============

void mostrarMenu() {
    printf("\n----- MENÚ PRINCIPAL -----\n");
    printf("1. Agregar Estudiante\n");
    printf("2. Listar Estudiantes\n");
    printf("3. Modificar Estudiante\n");
    printf("4. Eliminar Estudiante\n");
    printf("5. Buscar Estudiante por Nombre\n");
    printf("6. Buscar Estudiante por Edad\n");
    printf("7. Agregar Materia\n");
    printf("8. Listar Materias\n");
    printf("9. Inscribir Estudiante en Materia\n");
    printf("10. Salir\n");
    printf("11. Rendir Materia\n");
}

void ordenarEstudiantesPorNombre(Estudiante estudiantes[], int totalEstudiantes) {
    Estudiante temp;
    for (int i = 0; i < totalEstudiantes - 1; i++) {
        for (int j = i + 1; j < totalEstudiantes; j++) {
            if (strcmp(estudiantes[i].nombre, estudiantes[j].nombre) > 0) {
                temp = estudiantes[i];
                estudiantes[i] = estudiantes[j];
                estudiantes[j] = temp;
            }
        }
    }
}

void ordenarMateriasPorNombre(Materia materias[], int totalMaterias) {
    Materia temp;
    for (int i = 0; i < totalMaterias - 1; i++) {
        for (int j = i + 1; j < totalMaterias; j++) {
            if (strcmp(materias[i].nombre, materias[j].nombre) > 0) {
                temp = materias[i];
                materias[i] = materias[j];
                materias[j] = temp;
            }
        }
    }
}

void cargarEstudiantesDesdeCSV(Estudiante estudiantes[], int *totalEstudiantes, const char *archivo) {
    FILE *file = fopen(archivo, "r");
    if (file == NULL) {
        // No mostrar mensaje de error, simplemente iniciar sin datos
        return;
    }

    while (fscanf(file, "%d,%99[^,],%d,%f\n",
                  &estudiantes[*totalEstudiantes].id,
                  estudiantes[*totalEstudiantes].nombre,
                  &estudiantes[*totalEstudiantes].edad,
                  &estudiantes[*totalEstudiantes].promedio) != EOF) {
        (*totalEstudiantes)++;
    }
    fclose(file);
    printf("Estudiantes cargados desde el archivo %s.\n", archivo);
}

void guardarEstudiantesEnCSV(Estudiante estudiantes[], int totalEstudiantes, const char *archivo) {
    FILE *file = fopen(archivo, "w");
    if (file == NULL) {
        printf("No se pudo abrir el archivo %s para guardar.\n", archivo);
        return;
    }

    for (int i = 0; i < totalEstudiantes; i++) {
        fprintf(file, "%d,%s,%d,%.2f\n",
                estudiantes[i].id,
                estudiantes[i].nombre,
                estudiantes[i].edad,
                estudiantes[i].promedio);
    }

    fclose(file);
    printf("Estudiantes guardados en el archivo %s.\n", archivo);
}

void cargarMateriasDesdeCSV(Materia materias[], int *totalMaterias, const char *archivo) {
    FILE *file = fopen(archivo, "r");
    if (file == NULL) {
        // No mostrar mensaje de error, simplemente iniciar sin datos
        return;
    }

    while (fscanf(file, "%d,%99[^,],%d\n",
                  &materias[*totalMaterias].codigo,
                  materias[*totalMaterias].nombre,
                  &materias[*totalMaterias].cantidadCorrelativas) != EOF) {
        for (int i = 0; i < materias[*totalMaterias].cantidadCorrelativas; i++) {
            fscanf(file, "%d", &materias[*totalMaterias].correlativas[i]);
        }
        (*totalMaterias)++;
    }
    fclose(file);
    printf("Materias cargadas desde el archivo %s.\n", archivo);
}

void guardarMateriasEnCSV(Materia materias[], int totalMaterias, const char *archivo) {
    FILE *file = fopen(archivo, "w");
    if (file == NULL) {
        printf("No se pudo abrir el archivo %s para guardar.\n", archivo);
        return;
    }

    for (int i = 0; i < totalMaterias; i++) {
        fprintf(file, "%d,%s,%d",
                materias[i].codigo,
                materias[i].nombre,
                materias[i].cantidadCorrelativas);
        for (int j = 0; j < materias[i].cantidadCorrelativas; j++) {
            fprintf(file, ",%d", materias[i].correlativas[j]);
        }
        fprintf(file, "\n");
    }

    fclose(file);
    printf("Materias guardadas en el archivo %s.\n", archivo);
}

int esIdUnico(Estudiante estudiantes[], int totalEstudiantes, int id) {
    for (int i = 0; i < totalEstudiantes; i++) {
        if (estudiantes[i].id == id) {
            return 0;
        }
    }
    return 1;
}

int verificarCorrelativas(Materia materias[], int totalMaterias, Estudiante *estudiante, const char *materia) {
    for (int i = 0; i < totalMaterias; i++) {
        if (strcmp(materias[i].nombre, materia) == 0) {
            for (int j = 0; j < materias[i].cantidadCorrelativas; j++) {
                int correlativaEncontrada = 0;
                for (int k = 0; k < estudiante->cantidadMaterias; k++) {
                    if (strcmp(estudiante->materiaInscrita[k], materias[materias[i].correlativas[j]].nombre) == 0) {
                        correlativaEncontrada = 1;
                        break;
                    }
                }
                if (!correlativaEncontrada) {
                    return 0;
                }
            }
            return 1;
        }
    }
    return 0;
}

// ============ FUNCIÓN PRINCIPAL ============

int main() {
    Estudiante estudiantes[MAX_ESTUDIANTES];
    Materia materias[MAX_MATERIAS];
    int totalEstudiantes = 0;
    int totalMaterias = 0;
    int opcion;

    cargarEstudiantesDesdeCSV(estudiantes, &totalEstudiantes, "estudiantes.csv");
    cargarMateriasDesdeCSV(materias, &totalMaterias, "materias.csv");

    while (1) {
        mostrarMenu();
        printf("\nIngrese una opción: ");
        if (scanf("%d", &opcion) != 1) {
            printf("Entrada inválida. Intente nuevamente.\n");
            while (getchar() != '\n');
            continue;
        }
        while (getchar() != '\n');

        switch (opcion) {
        case 1:
            agregarEstudiante(estudiantes, &totalEstudiantes);
            break;
        case 2:
            listarEstudiantes(estudiantes, totalEstudiantes);
            break;
        case 3:
            modificarEstudiante(estudiantes, totalEstudiantes);
            break;
        case 4: {
            int idEliminar;
            printf("Ingrese el ID del estudiante a eliminar: ");
            if (scanf("%d", &idEliminar) != 1) {
                printf("Entrada inválida.\n");
                while (getchar() != '\n');
                break;
            }
            while (getchar() != '\n');
            eliminarEstudiante(estudiantes, &totalEstudiantes, idEliminar);
        }
        break;
        case 5: {
            char nombreBuscar[100];
            printf("Ingrese el nombre del estudiante a buscar: ");
            fgets(nombreBuscar, sizeof(nombreBuscar), stdin);
            nombreBuscar[strcspn(nombreBuscar, "\n")] = 0;
            Estudiante *estudianteEncontrado = buscarEstudiantePorNombre(estudiantes, totalEstudiantes, nombreBuscar);
            if (estudianteEncontrado != NULL) {
                printf("Estudiante encontrado: ID: %d | Nombre: %s | Edad: %d | Promedio: %.2f\n",
                       estudianteEncontrado->id, estudianteEncontrado->nombre, 
                       estudianteEncontrado->edad, estudianteEncontrado->promedio);
            } else {
                printf("Estudiante no encontrado.\n");
            }
        }
        break;
        case 6: {
            int minEdad, maxEdad;
            printf("Ingrese el rango de edad (mínimo y máximo): ");
            if (scanf("%d %d", &minEdad, &maxEdad) != 2) {
                printf("Entrada inválida.\n");
                while (getchar() != '\n');
                break;
            }
            while (getchar() != '\n');
            Estudiante *estudianteEncontrado = buscarEstudiantePorEdad(estudiantes, totalEstudiantes, minEdad, maxEdad);
            if (estudianteEncontrado != NULL) {
                printf("Estudiante encontrado: ID: %d | Nombre: %s | Edad: %d | Promedio: %.2f\n",
                       estudianteEncontrado->id, estudianteEncontrado->nombre, 
                       estudianteEncontrado->edad, estudianteEncontrado->promedio);
            } else {
                printf("No se encontraron estudiantes en ese rango de edad.\n");
            }
        }
        break;
        case 7:
            agregarMateria(materias, &totalMaterias);
            break;
        case 8:
            listarMaterias(materias, totalMaterias);
            break;
        case 9: {
            int idEstudiante, codigoMateria;
            printf("Ingrese el ID del estudiante: ");
            if (scanf("%d", &idEstudiante) != 1) {
                printf("Entrada inválida.\n");
                while (getchar() != '\n');
                break;
            }
            while (getchar() != '\n');
            printf("Ingrese el código de la materia: ");
            if (scanf("%d", &codigoMateria) != 1) {
                printf("Entrada inválida.\n");
                while (getchar() != '\n');
                break;
            }
            while (getchar() != '\n');
            inscribirEstudianteEnMateria(estudiantes, totalEstudiantes, materias, totalMaterias, idEstudiante, codigoMateria);
        }
        break;
        case 10:
            guardarEstudiantesEnCSV(estudiantes, totalEstudiantes, "estudiantes.csv");
            guardarMateriasEnCSV(materias, totalMaterias, "materias.csv");
            printf("¡Hasta luego!\n");
            return 0;
        case 11: {
            int idEstudiante, codigoMateria;
            printf("Ingrese el ID del estudiante: ");
            if (scanf("%d", &idEstudiante) != 1) {
                printf("Entrada inválida.\n");
                while (getchar() != '\n');
                break;
            }
            while (getchar() != '\n');
            printf("Ingrese el código de la materia a rendir: ");
            if (scanf("%d", &codigoMateria) != 1) {
                printf("Entrada inválida.\n");
                while (getchar() != '\n');
                break;
            }
            while (getchar() != '\n');
            
            Estudiante *estudiante = buscarEstudiantePorId(estudiantes, totalEstudiantes, idEstudiante);
            Materia *materia = buscarMateriaPorCodigo(materias, totalMaterias, codigoMateria);
            
            if (estudiante && materia) {
                int inscrito = 0;
                for (int i = 0; i < estudiante->cantidadMaterias; i++) {
                    if (strcmp(estudiante->materiaInscrita[i], materia->nombre) == 0) {
                        inscrito = 1;
                        break;
                    }
                }
                if (inscrito) {
                    materia->aprobada = 1;
                    printf("Materia '%s' rendida y aprobada para el estudiante '%s'.\n", 
                           materia->nombre, estudiante->nombre);
                } else {
                    printf("El estudiante no está inscrito en esa materia.\n");
                }
            } else {
                printf("Estudiante o materia no encontrado.\n");
            }
        }
        break;
        default:
            printf("Opción no válida. Intente nuevamente.\n");
        }
    }

    return 0;
}